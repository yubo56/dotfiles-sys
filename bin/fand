#!/usr/bin/zsh

PTH=/sys/devices/platform/applesmc.768
LAST_FAN=2
SLEEP=3s

MIN=45
MAX=90

# enable manual control
for i in {1..${LAST_FAN}}; do
    echo "Enabling manual control for fan $i"
    echo 1 > ${PTH}/fan${i}_manual
done

while true; do
    sensors coretemp-isa-0000 -u | 'grep' temp1_input | tr -d ' ' | sed -nE 's/.*:(.*)\..*/\1/p' | read temp
    for i in {1..${LAST_FAN}}; do
        read fan_min < ${PTH}/fan${i}_min
        read fan_max < ${PTH}/fan${i}_max
        if (( $temp > $MAX )); then
            echo "Setting fan to $fan_max (max)"
            echo $fan_max > ${PTH}/fan${i}_output
        else
            bc <<< "scale=0; ($temp - $MIN) * ($fan_max - $fan_min) / ($MAX - $MIN) + $fan_min" | read fan
            echo "Setting fan to $fan"
            echo $fan > ${PTH}/fan${i}_output
        fi
    done
    sleep ${SLEEP}
done
