#!/usr/bin/zsh

sep='|'
refresh_interval=1

DP1_val='disconnected'
HDMI1_val='disconnected'

while true; do
    startTime=$(date +%s%N) # sleep (1s - execution time)
    #--------------------------------------------------------TOGGLE SCREEN WHEN CONNECTED----------------------------------------

    # different machines have different names

    echo $DP1_val, $HDMI1_val
    if [[ "$(hostname)" =~ BlendArch ]]; then
        # if exists
        if [[ -a /sys/class/drm/card0-DP-1 ]]; then
            # if status changed
            if [[ $(cat /sys/class/drm/card0-DP-1/status) != $DP1_val ]]; then
                # update status, xrandr auto
                read DP1_val < /sys/class/drm/card0-DP-1/status
                echo "Changing because new $DP1_val"
                xrandr --output DP-1 --auto --left-of eDP-1
            fi
        fi

        if [[ -a /sys/class/drm/card0-HDMI-A-1 ]]; then
            if [[ $(cat /sys/class/drm/card0-HDMI-A-1/status) != $HDMI1_val ]]; then
                read HDMI1_val < /sys/class/drm/card0-HDMI-A-1/status
                echo "Changing because new $HDMI1_val"
                xrandr --output HDMI-1 --auto --left-of eDP-1
            fi
        fi
    else
        # TODO
    fi

    #--------------------------------------------------------CALCULATE CPU USAGE----------------------------------------
    cpustat=`cat /proc/stat | head -n 1`
    prevused=${prevused:-0}
    previdle=${previdle:-0}
    used=${used:-0}
    idle=${idle:-0}
    read _name user nice system incidle _y <<< $cpustat

    (( used = $user + $nice + $system ))
    (( idle = $incidle ))

    bccmd="scale=1;\
        100 * \
            ($used - $prevused) /\
            (($used - $prevused) + ($idle - $previdle))"
    usage=$(bc <<< $bccmd)
    prevused=$used
    previdle=$idle

    #-------------------------------------------------------MEMSTATS--------------------------------------------
    total=$(cat /proc/meminfo | grep MemTotal | sed -e 's/MemTotal://g' -e 's/kB//g' -e 's/ //g')
    free=$(cat /proc/meminfo | grep MemFree | sed -e 's/MemFree://g' -e's/kB//g' -e 's/ //g')
    mem=$(echo "scale=0;($total - $free)*100/$total" | 'bc')

    #-------------------------------------------------------BATTSTATS--------------------------------------------
    battstat="N/A"
    [[ -e /sys/class/power_supply/BAT0/status ]] &&
        battstat=$(cat /sys/class/power_supply/BAT0/status | awk '{print substr($0,0,1)}') &&
        read battperc < /sys/class/power_supply/BAT0/capacity


    #-------------------------------------------------------VOLUME--------------------------------------------
    vol=$(amixer get Master | grep 'Mono:' | perl -e "my \$string = <>;print \"Mu\" if \$string =~ /off/;\$string =~ s/\[(\d+)%\]// if \$string =~ /\[on\]/;print \$1;")

    #------------------------------------------------------BRIGHTNESS------------------------------------------
    if [[ -f $brightfile ]]; then
        bright=$(echo "scale=0;$(cat $brightfile) * 100 / $(cat $brightmax)" | bc)
    fi


    #-------------------------------------------------------SET INTERNET RELATED STUFF--------------------------------------------

    #format weather string
    if [[ -s /tmp/weather ]]; then
        weather="$(cat /tmp/weather)${sep}"
    else
        weather=""
    fi

    #---------------------------------------------------FIND KBLAYOUT----------------------------------------
    layout=$(setxkbmap -query | grep variant)
    if [[ $layout =~ "dvorak-l" ]]; then layout="L"
    else if [[ $layout =~ "dvorak-intl" ]]; then layout="DI"
    else if [[ $layout =~ "dvorak" ]]; then layout="D"
    else  layout="U";fi;fi;fi

    #---------------------------------------------------------- TEMPERATURE ----------------------------------------------------------
    # if [[ "$(hostname)" =~ ArchTest ]]; then
    #     temp=$(acpi -t | grep "Thermal 0:" | grep -v "trip point" | awk '{print($4)}' | sed 's/\.0//g')
    #     temp="$temp/$(acpi -t | grep "Thermal 1:" | grep -v "trip point" | awk '{print($4)}' | sed 's/\.0//g')"
    # fi
    read temp < /sys/devices/platform/coretemp.0/hwmon/hwmon*/temp1_input
    temp="${sep}T:${temp:0:-3}"
    # temp="·온도:$temp"

    #---------------------------------------------------------- SIGNAL STRENGTH QUALITY/LEVEL -----------------------------------------
    # net=$(cat /proc/net/wireless | grep ':' | sed 's/\.//g' | awk '{print $3"/"$4}')
    if ! [[ -z $(iw list) ]]; then
        net=$(iw dev $WIFI link | grep signal | awk '{print $2}' | sed 's/\ //g')
    fi

    #-------------------------------------------------------SET REPLY--------------------------------------------
    # REPLY="电:$battperc$battstat$temp${sep}亮:$bright${sep}网:$net${sep}声:$vol${sep}脑:$usage${sep}内:$mem${sep}$weather`date +%a|~/bin/dateWeek``date +'%d/%m/%y %H:%M:%S'`$layout"
    # REPLY="B:$battperc$battstat$temp${sep}B:$bright${sep}W:$net${sep}V:$vol${sep}C:$usage${sep}M:$mem${sep}$weather`date +%a|~/bin/dateWeek``date +'%m/%d/%y %H:%M:%S'`$layout"
    # REPLY="전기:$battperc$battstat$temp·명도:$bright·랜:$net·체적:$vol·심장:$usage·기억:$mem·$weather`date +%a|~/bin/dateWeek``date +'%m/%d/%y %H:%M:%S'`$layout"
    if [[ $net  == '' ]]
    then
        REPLY="B:$battperc$battstat$temp${sep}V:$vol${sep}C:$usage${sep}M:$mem${sep}$weather`date +%a|~/bin/dateWeek``date +'%m/%d/%y %H:%M:%S'`$layout"
    else
        REPLY="B:$battperc$battstat$temp${sep}W:$net${sep}V:$vol${sep}C:$usage${sep}M:$mem${sep}$weather`date +%a|~/bin/dateWeek``date +'%m/%d/%y %H:%M:%S'`$layout"
    fi

    if [[ "$(hostname)" =~ BlendArch ]]; then
        read fan_in < /sys/devices/platform/applesmc.768/fan1_output
        read fan_min < /sys/devices/platform/applesmc.768/fan1_min
        read fan_max < /sys/devices/platform/applesmc.768/fan1_max
        FAN=$(echo "scale=0;($fan_in - $fan_min)*100/($fan_max - $fan_min)" | 'bc')
        REPLY="F:${FAN}|${REPLY}"
    fi


    xsetroot -name "$REPLY"
    sleep $((( $refresh_interval - ($(date +%s%N) - $startTime) / 1000000000.0 )))s
done
